#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#include <string.h>
#include <assert.h>

#include "quic_provider.h"

#ifndef CDECL
  #if _WIN32
    #define CDECL __cdecl
  #else
    #define CDECL
  #endif
#endif

void dump(unsigned char buffer[], size_t len)
{
  size_t i;
  for(i=0; i<len; i++) {
    printf("%02x",buffer[i] & 0xFF);
    if (i % 32 == 31 || i == len-1) printf("\n");
  }
}

// Older coverage tests
void coverage(void)
{
  printf("==== coverage ====\n");

  unsigned char hash[64] = {0};
  unsigned char input[1] = {0};
  printf("SHA256('') =\n");
  quic_crypto_hash(TLS_hash_SHA256, hash, input, 0);
  dump(hash, 32);
  printf("\nSHA384('') = \n");
  quic_crypto_hash(TLS_hash_SHA384, hash, input, 0);
  dump(hash, 48);
  printf("\nSHA512('') = \n");
  quic_crypto_hash(TLS_hash_SHA512, hash, input, 0);
  dump(hash, 64);

  unsigned char *key = (unsigned char *)"Jefe";
  unsigned char *data = (unsigned char *)"what do ya want for nothing?";

  printf("\nHMAC-SHA256('Jefe', 'what do ya want for nothing?') = \n");
  quic_crypto_hmac(TLS_hash_SHA256, hash, key, 4, data, 28);
  dump(hash, 32);
  assert(memcmp(hash, "\x5b\xdc\xc1\x46\xbf\x60\x75\x4e\x6a\x04\x24\x26\x08\x95\x75\xc7\x5a\x00\x3f\x08\x9d\x27\x39\x83\x9d\xec\x58\xb9\x64\xec\x38\x43", 32) == 0);

  printf("\nHMAC-SHA384('Jefe', 'what do ya want for nothing?') = \n");
  quic_crypto_hmac(TLS_hash_SHA384, hash, key, 4, data, 28);
  dump(hash, 48);
  assert(memcmp(hash, "\xaf\x45\xd2\xe3\x76\x48\x40\x31\x61\x7f\x78\xd2\xb5\x8a\x6b\x1b\x9c\x7e\xf4\x64\xf5\xa0\x1b\x47\xe4\x2e\xc3\x73\x63\x22\x44\x5e\x8e\x22\x40\xca\x5e\x69\xe2\xc7\x8b\x32\x39\xec\xfa\xb2\x16\x49", 48) == 0);

  printf("\nHMAC-SHA512('Jefe', 'what do ya want for nothing?') = \n");
  quic_crypto_hmac(TLS_hash_SHA512, hash, key, 4, data, 28);
  dump(hash, 64);
  assert(memcmp(hash, "\x16\x4b\x7a\x7b\xfc\xf8\x19\xe2\xe3\x95\xfb\xe7\x3b\x56\xe0\xa3\x87\xbd\x64\x22\x2e\x83\x1f\xd6\x10\x27\x0c\xd7\xea\x25\x05\x54\x97\x58\xbf\x75\xc0\x5a\x99\x4a\x6d\x03\x4f\x65\xf8\xf0\xe6\xfd\xca\xea\xb1\xa3\x4d\x4a\x6b\x4b\x63\x6e\x07\x0a\x38\xbc\xe7\x37", 64) == 0);

  unsigned char *salt = (unsigned char *)"\x00\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c";
  unsigned char *ikm = (unsigned char *)"\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b";
  unsigned char *info = (unsigned char *)"\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9";

  printf("\nprk = HKDF-EXTRACT-SHA256('0x000102030405060708090a0b0c', '0x0b0b0b0b0b0b0b0b0b0b0b0b0b0b0b0b0b0b0b0b0b0b')\n");
  quic_crypto_hkdf_extract(TLS_hash_SHA256, hash, salt, 13, ikm, 22);
  dump(hash, 32);

  unsigned char prk[32] = {0};
  memcpy(prk, hash, 32);
  dump(prk, 32);

  unsigned char okm[42] = {0};
  printf("\nokm = HKDF-EXPAND-SHA256(prk, '0xf0f1f2f3f4f5f6f7f8f9', 42)\n");
  if(!quic_crypto_hkdf_expand(TLS_hash_SHA256, okm, 42, prk, 32, info, 10))
  {
    printf("Failed to call HKDF-expand\n");
    exit(1);
  }
  dump(okm, 42);

  quic_secret s = { .hash = TLS_hash_SHA256, .ae = TLS_aead_AES_128_GCM };
  memcpy(s.secret, hash, 32);
  quic_crypto_tls_derive_secret(&s, &s, "EXPORTER-QUIC server 1-RTT Secret");

  quic_key* k;
  if(!quic_crypto_derive_key(&k, &s))
  {
    printf("Failed to derive key\n");
    exit(1);
  }

  unsigned char cipher[128];
  printf("\nAES-128-GCM encrypt test:\n");
  quic_crypto_encrypt(k, cipher, 0, salt, 13, data, 28);
  dump(cipher, 28+16);

  if(quic_crypto_decrypt(k, hash, 0, salt, 13, cipher, 28+16)) {
    printf("DECRYPT SUCCES: \n");
    dump(hash, 28);
  } else {
    printf("DECRYPT FAILED.\n");
  }
  quic_crypto_free_key(k);

  s.hash = TLS_hash_SHA256;
  s.ae = TLS_aead_CHACHA20_POLY1305;

  if(!quic_crypto_derive_key(&k, &s))
  {
    printf("Failed to derive key\n");
    exit(1);
  }

  printf("\nCHACHA20-POLY1305 encrypt test:\n");
  quic_crypto_encrypt(k, cipher, 0x29e255a7, salt, 13, data, 28);
  dump(cipher, 28+16);

  if(quic_crypto_decrypt(k, hash, 0x29e255a7, salt, 13, cipher, 28+16)) {
    printf("DECRYPT SUCCES: \n");
    dump(hash, 28);
  } else {
    printf("DECRYPT FAILED.\n");
  }

  quic_crypto_free_key(k);
  printf("==== PASS:  coverage ====\n\n\n");
}

//////////////////////////////////////////////////////////////////////////////


const uint64_t sn = 0x29;

#define ad_len      0x11
const unsigned char ad[ad_len] =
{0xff,0x00,0x00,0x4f,0xee,0x00,0x00,0x42,0x37,0xff,0x00,0x00,0x09,0x00,0x00,0x00};

#define plain_len 256
const unsigned char plain[plain_len] = {
0x12,0x00,0x40,0xda,0x16,0x03,0x03,0x00,0xd5,0x01,0x00,0x00,0xd1,0x03,0x03,0x5a,
0xa0,0x4e,0xf1,0x3b,0x74,0x7c,0x34,0xe6,0x74,0x05,0xc9,0x1f,0x0a,0x2a,0x5c,0x5d,
0x1f,0xf9,0x08,0x01,0x77,0xb5,0xe8,0x35,0x94,0x34,0x70,0xbd,0xdd,0x86,0xa5,0x00,
0x00,0x04,0x13,0x03,0x13,0x01,0x01,0x00,0x00,0xa4,0x00,0x1a,0x00,0x2c,0xff,0x00,
0x00,0x09,0x00,0x26,0x00,0x01,0x00,0x04,0x00,0x10,0x00,0x00,0x00,0x00,0x00,0x04,
0x00,0x04,0x00,0x00,0x00,0x02,0x00,0x04,0x00,0x00,0x00,0x21,0x00,0x08,0x00,0x04,
0x00,0x00,0x00,0x23,0x00,0x03,0x00,0x02,0x00,0x64,0x00,0x2b,0x00,0x03,0x02,0x7f,
0x17,0x00,0x33,0x00,0x26,0x00,0x24,0x00,0x1d,0x00,0x20,0x33,0xc5,0x86,0xee,0x6c
};

const unsigned char cipher_sha256_aes128[] = { // results_3_0
0x05,0x7e,0x9f,0x33,0xb5,0x37,0x88,0x72,0x96,0x43,0x3f,0x8f,0x29,0x84,0xa0,0xec,
0xc4,0xdd,0x31,0xa2,0x76,0x21,0x84,0x5b,0x9e,0xfc,0x95,0xfa,0x4a,0x7a,0x73,0x64,
0xdb,0xbd,0x5d,0x23,0xbf,0x4d,0xf6,0x96,0x54,0x7b,0xf5,0xc2,0xce,0xf8,0xa2,0x4d,
0x6f,0x42,0x70,0xc5,0xd0,0xd1,0x84,0xc1,0x56,0x18,0x8f,0xaf,0xa7,0xf9,0x2f,0xd1,
0xab,0x8d,0x52,0x26,0x3d,0x66,0x27,0x6d,0x45,0x25,0x73,0x23,0xa6,0x80,0x67,0xa9,
0xb7,0xa1,0x63,0x49,0xac,0xb7,0x6a,0xf8,0x75,0x8a,0xde,0x81,0x16,0xe3,0x6d,0x12,
0x82,0xc1,0x1d,0xe5,0xf4,0x72,0x15,0x7b,0xa1,0x77,0x76,0xb1,0x76,0x31,0xa2,0x47,
0xd6,0x0d,0x4f,0xf4,0xb2,0xd4,0x92,0x83,0xfd,0x51,0x31,0xc8,0x8b,0x2c,0xbc,0xc8,
0xa0,0x88,0xcf,0x6b,0xf2,0xc8,0x39,0x00,0x2f,0x80,0x70,0xf5,0x56,0x70,0x7a,0x18,
0x7c,0xe4,0xa6,0x6b,0xc2,0x3e,0xd8,0xc6,0xc8,0x0a,0x50,0x6d,0xac,0x37,0x0d,0xcd,
0x6e,0xe9,0x41,0xb9,0x31,0x22,0xe4,0xf2,0x5b,0xd3,0x0f,0x3c,0xa4,0xcb,0x90,0x34,
0xdf,0x01,0x00,0x50,0x8c,0x83,0x41,0x6b,0x5e,0x7f,0x0a,0xd3,0x72,0x2d,0x01,0xc3,
0xd8,0xb5,0x78,0x0a,0xc4,0xc5,0xbc,0xdb,0xf5,0xe4,0x09,0x17,0xf3,0x5a,0xd4,0xa7,
0x8c,0x39,0xe5,0x67,0x1c,0x96,0xc5,0xdc,0xb4,0x83,0x45,0x71,0x3d,0x06,0x13,0x16,
0x04,0x94,0x3e,0xe0,0x2c,0xaa,0x31,0xff,0xec,0xa3,0xa9,0x2f,0x06,0xd8,0x64,0xb9,
0xea,0xad,0x16,0xbf,0xd5,0xc5,0xda,0xfc,0x73,0xbd,0xe7,0x68,0x30,0x4e,0xeb,0xca,
0x8d,0x3e,0xcd,0xee,0xe8,0x67,0x14,0xb0,0x11,0x71,0x3e,0x9f,0xc3,0xb3,0x65,0x96,
};

const unsigned char cipher_sha384_aes128[] = { // results_4_0
0x3b,0x71,0xb8,0x7c,0xa5,0xa9,0xe5,0x6f,0x71,0xa8,0x78,0x4f,0x15,0xd2,0xd7,0x4f,
0x3c,0x2e,0xf8,0x91,0x88,0x87,0x12,0xe4,0x36,0x24,0xf0,0x51,0x01,0x47,0x66,0xc5,
0xdc,0x46,0x36,0x0d,0x7a,0x5e,0xbe,0x85,0xc0,0x44,0x78,0x21,0xcb,0xc5,0xba,0x76,
0x5e,0x27,0xe1,0xba,0xf8,0x38,0xd7,0x90,0xa9,0xc1,0x33,0x0a,0x24,0x1f,0x5d,0xf5,
0x9a,0xfe,0x4f,0x20,0x37,0xf3,0x66,0xe7,0xdd,0x0b,0xc6,0x2d,0x0f,0x6b,0xcf,0xfc,
0x03,0xbb,0x88,0x90,0xc3,0x82,0x41,0x4d,0xcb,0x97,0x5f,0xef,0x49,0xac,0x41,0x82,
0x02,0x11,0x59,0x80,0xdb,0x80,0x8d,0x62,0x55,0x24,0x45,0x02,0x42,0xfe,0xa5,0x66,
0xad,0xa7,0xd2,0xf4,0xe7,0xbe,0x0f,0x03,0x87,0xb8,0x04,0xe6,0xbb,0xd6,0xfb,0x63,
0xc3,0x99,0x96,0xf0,0x95,0x87,0xc1,0x0b,0xf3,0x74,0xfd,0x7f,0x6f,0xa1,0xda,0xb0,
0xa2,0x8b,0x18,0x10,0x26,0x46,0x00,0x81,0x9a,0x87,0xb8,0xbf,0xe5,0xcb,0x7e,0x63,
0xf9,0x81,0xd3,0x3b,0xc1,0x19,0x51,0x5d,0x74,0xc7,0x27,0xae,0xb4,0xb9,0xa5,0xa3,
0x1e,0x1b,0xd1,0x4f,0xee,0x3e,0xf5,0x62,0x68,0x06,0xb3,0x2e,0xfd,0x79,0xa0,0x7d,
0x32,0x6d,0xba,0x62,0xc4,0x0c,0x9f,0xbe,0x1c,0xd8,0x69,0xa0,0x20,0xe1,0xba,0x82,
0x38,0x9c,0x6c,0xa7,0xb4,0xb0,0xba,0x5f,0xa9,0xa5,0x89,0x9c,0x31,0x76,0xe0,0x85,
0x22,0x5a,0x75,0x5b,0xe7,0x42,0x81,0x92,0x9d,0xc3,0x56,0x16,0x83,0x73,0x9f,0xfd,
0xdd,0x53,0x1a,0x6c,0x19,0xd1,0xd0,0x1b,0x1d,0xef,0x2d,0x97,0xfe,0x3d,0x71,0x71,
0x2c,0x33,0xb5,0xb9,0x20,0xa4,0x2a,0x90,0x4e,0xde,0x3e,0xc7,0x32,0xbc,0xfd,0x3b,
};

const unsigned char cipher_sha512_aes128[] = { // results_5_0
0x20,0x97,0x0a,0xe4,0xf8,0x56,0xad,0x61,0xe6,0xa5,0x39,0x82,0x17,0x41,0xbd,0xff,
0x1d,0xd4,0x8b,0x14,0x21,0x56,0x41,0xc5,0x61,0x5c,0x7d,0x40,0x82,0x9d,0x13,0x3b,
0x7f,0x90,0x53,0xfb,0xbb,0x7b,0x05,0x08,0x4b,0x03,0xcc,0x43,0x23,0x9b,0xeb,0x42,
0x73,0xab,0x28,0x71,0x1c,0x79,0x37,0x65,0x03,0xcf,0xc9,0x65,0x68,0x54,0xd4,0x34,
0xdd,0xfe,0x62,0x90,0xfa,0x34,0xb1,0xc1,0x5c,0xd7,0x6f,0xd3,0x9b,0x03,0x52,0x47,
0xdb,0x5f,0x7e,0x02,0x31,0x35,0x46,0x38,0x1b,0x84,0x63,0xec,0x6f,0x7c,0xd1,0xd5,
0xfb,0x76,0xc4,0x5e,0xca,0x38,0x91,0x44,0x0d,0xb8,0x1a,0x57,0x24,0xf2,0xb8,0x16,
0x02,0xe5,0xd6,0x75,0x66,0xa5,0x3f,0xd6,0x4a,0xd8,0x9e,0xb5,0x56,0x50,0xf1,0x62,
0xf9,0xb0,0x01,0x7e,0xca,0xfd,0x9d,0xdc,0xde,0xdf,0x81,0x5a,0x72,0x5f,0x65,0x65,
0x8a,0xdc,0xa6,0x8a,0x43,0x7e,0x13,0x60,0xdc,0x70,0xf1,0xa2,0x37,0xbd,0x9a,0x9d,
0x21,0x6f,0x88,0xea,0xe3,0x8d,0x24,0x5e,0x5d,0xb6,0xae,0xfd,0x46,0xb0,0x28,0xb7,
0xd9,0x31,0xd0,0xd6,0x60,0x67,0x21,0xe4,0x34,0xe2,0x68,0x50,0x69,0xb0,0xa8,0x4d,
0x03,0x76,0x54,0x6c,0x4c,0x62,0x5f,0x8a,0xf9,0x2d,0x1d,0x14,0xb7,0x97,0xc3,0xd8,
0xdf,0x2a,0x4c,0x72,0x02,0xfe,0xfd,0x74,0x61,0x65,0x13,0x82,0xae,0x40,0xab,0x0f,
0x0e,0x79,0x92,0xc3,0x02,0x3e,0xe9,0x6f,0x7a,0xaa,0x9a,0x7a,0xa1,0x85,0xa8,0xec,
0x7a,0x11,0x95,0xf5,0x30,0x37,0x98,0xf4,0x32,0x29,0xb7,0xc6,0xf5,0xd7,0x8b,0x08,
0x51,0xff,0x43,0xc5,0xbd,0x16,0x56,0xd1,0x34,0x3d,0xc5,0xdb,0x25,0x9a,0xc3,0xd7,
};

const unsigned char cipher_sha256_aes256[] = { // results_3_1
0x30,0x5c,0xdd,0x18,0xfd,0xb0,0x2f,0x71,0xc3,0x11,0x43,0xa6,0xe9,0x7f,0x6f,0x39,
0x9a,0x72,0x89,0x7d,0x19,0x86,0xcd,0xce,0xa2,0xb3,0xc1,0xd2,0x2a,0x97,0x85,0xa8,
0x77,0x3c,0x31,0x8b,0xf6,0x83,0x52,0xee,0xc4,0x0e,0x37,0x0d,0x5c,0x62,0x88,0xfb,
0x81,0x0d,0x91,0xb4,0x69,0x5f,0xcd,0xc8,0xdf,0x61,0x72,0xd1,0x52,0xa7,0xcc,0xcb,
0x4d,0x07,0xcd,0xb2,0x26,0xd6,0x44,0x86,0x93,0x81,0x5f,0xf0,0x0b,0x77,0xb0,0x0b,
0x66,0xc9,0x2a,0x19,0xd8,0x0c,0x47,0x33,0x84,0x87,0xe2,0x09,0x53,0xec,0x16,0xcb,
0x30,0x89,0x3c,0xe5,0x93,0xfd,0x6f,0x07,0xf8,0x08,0xd7,0xe4,0x48,0x79,0x65,0xf2,
0x14,0x14,0xf4,0xbf,0x79,0x61,0x09,0x5e,0x3b,0x3d,0x9b,0x6d,0x3f,0x7f,0x71,0xb5,
0x46,0x17,0x70,0xfa,0x00,0xe6,0x7a,0xe9,0x39,0x76,0x18,0xe2,0x0b,0x7e,0xd7,0x5e,
0x08,0x04,0x90,0xe1,0x9f,0x04,0xe3,0x07,0x90,0x74,0x16,0x48,0xf7,0x4b,0x73,0xaa,
0xd5,0xba,0x19,0x14,0x89,0xba,0x87,0x29,0x1d,0x1f,0xc5,0x94,0x01,0xaf,0x08,0x3b,
0x1b,0x70,0x43,0xee,0x1f,0xa9,0x1c,0x61,0x8d,0x81,0x7e,0x52,0x25,0x9f,0x2f,0xc8,
0x80,0xe1,0xa9,0xa5,0x16,0x65,0x5f,0x46,0x0e,0x2c,0x10,0x2b,0x71,0xbb,0xa3,0x1f,
0x1c,0x97,0xdc,0x5d,0xdc,0x80,0x59,0xa7,0xcb,0x07,0x53,0x80,0x8b,0xc7,0xa8,0x1e,
0x2e,0xa6,0x47,0xe8,0x18,0xab,0x0a,0xc4,0x7e,0x41,0xce,0x05,0x5c,0xf5,0x41,0x30,
0x5b,0x98,0x98,0x1e,0x4d,0xf5,0xc2,0x55,0xc6,0x9e,0xd2,0x26,0x9a,0x46,0x4a,0xd1,
0x4a,0x04,0x08,0xb4,0xe9,0x2c,0xd4,0x34,0x16,0x0d,0x79,0xe1,0xff,0xd0,0x9a,0x7c,
};

const unsigned char cipher_sha384_aes256[] = { // results_4_1
0x49,0x95,0x55,0xbb,0xa5,0xdc,0x08,0xab,0x12,0x52,0x21,0xd3,0x57,0xbe,0xe5,0xf7,
0x78,0xf3,0xea,0xf7,0xc2,0xa3,0x05,0x94,0x18,0xb3,0x12,0x42,0x34,0xb1,0x19,0x64,
0x48,0x17,0x01,0xcd,0x2c,0xfd,0x01,0x77,0x6f,0x21,0xd4,0x59,0x95,0xc2,0x3a,0x35,
0x78,0xa2,0x19,0xc8,0xf4,0xc5,0x6a,0xc6,0xb3,0x02,0x9f,0x5e,0xd6,0x9f,0xdf,0x47,
0xde,0xcc,0x9c,0xe0,0x23,0x4e,0xf4,0xd2,0xb4,0x2c,0x4d,0x7b,0xd9,0xff,0x4e,0x15,
0x7c,0x19,0x48,0x31,0xed,0xae,0x5d,0x97,0x4a,0x1e,0x11,0xf3,0x84,0xf9,0xa2,0x98,
0xee,0xc5,0x61,0x06,0x7b,0x8e,0x1b,0x4b,0xae,0x87,0x66,0x39,0xc0,0xc1,0xaa,0x49,
0xe8,0x69,0x9f,0xdc,0x6e,0x1d,0x00,0x9f,0xff,0x44,0x21,0xb6,0xf3,0x2a,0x3d,0x74,
0x3c,0x7e,0x96,0x8f,0x0a,0x16,0x27,0xf7,0xa4,0x89,0x9b,0x65,0x91,0x25,0x0b,0x28,
0xd6,0x16,0x98,0x41,0x2e,0x68,0x39,0x4c,0x76,0xfb,0x32,0x32,0x6a,0x50,0x33,0x05,
0x79,0x8e,0x05,0x42,0x6e,0x0f,0xfb,0xc6,0xb3,0x42,0x67,0xe3,0x7e,0xa5,0xfe,0xdc,
0x38,0xa2,0xc5,0x0d,0x18,0xe9,0x21,0xc5,0x2e,0x17,0x3a,0xab,0xcc,0x91,0xff,0x58,
0xb4,0x06,0x2e,0x29,0xab,0xb3,0x2b,0xa4,0x28,0xa1,0xba,0x17,0x1d,0xa5,0xf4,0x1d,
0x86,0x3d,0x3f,0x30,0x96,0x1a,0x85,0xa3,0x74,0xaf,0xf1,0xa4,0x1f,0xd4,0x04,0xfb,
0xfb,0x57,0x84,0x56,0xa2,0xef,0x5e,0x01,0xba,0x86,0xef,0x00,0x4a,0x10,0x2c,0x79,
0x55,0x2a,0x2d,0x0a,0xda,0xa8,0x04,0x7f,0x20,0x70,0x3b,0xcd,0x75,0x3f,0x00,0x8e,
0xe9,0xd3,0xdf,0x1f,0x2e,0xc4,0x42,0x29,0x62,0x56,0x93,0xfc,0xf6,0x2b,0x8a,0x57,
};

const unsigned char cipher_sha512_aes256[] = { // results_5_1
0x04,0x14,0xbc,0x4c,0xfe,0x31,0xa9,0x5f,0x57,0x3f,0x23,0xdb,0x84,0x14,0x95,0xaf,
0xe3,0x22,0x58,0x44,0xc9,0x6b,0xe1,0x8d,0xd0,0x89,0x67,0x9c,0xbd,0xee,0x79,0xa8,
0xc7,0x23,0x05,0x3d,0xd9,0xcc,0x0e,0x90,0x86,0x15,0x6c,0xf2,0x3a,0x87,0xd1,0xd4,
0xe6,0x7e,0x82,0xb9,0x81,0x31,0xea,0xfb,0x85,0x2f,0x08,0x42,0x7c,0x9d,0x32,0x69,
0x6f,0xf7,0xda,0x1a,0x7d,0xd7,0x1a,0xc7,0xcd,0xde,0xd1,0x1a,0x5c,0xfc,0x52,0x94,
0xc8,0x50,0x48,0xf9,0x27,0x99,0xef,0xd4,0x09,0x1f,0x82,0x1e,0x8e,0x13,0xfc,0x92,
0x42,0x03,0xcc,0xd1,0x8c,0xc6,0xeb,0x0f,0x53,0x17,0x1b,0x53,0x2a,0x57,0x22,0x5c,
0x60,0x1d,0xac,0xb7,0x9b,0xe5,0xbe,0x31,0x1d,0x3c,0x5e,0x48,0x45,0xc1,0xa4,0x1c,
0x64,0x6e,0x0b,0x6b,0x0c,0xfe,0x6f,0xb1,0xd5,0xc9,0x18,0x9d,0x95,0x88,0x07,0xd2,
0xc8,0xe3,0x02,0x68,0x3a,0x7f,0x0c,0xfa,0x47,0xde,0xc7,0x0c,0x91,0xa5,0xac,0x95,
0x07,0xb4,0x8b,0xad,0x18,0x2f,0x4a,0xc8,0x0a,0x45,0x78,0x50,0x3b,0x23,0x1a,0xb0,
0x57,0x8f,0xbe,0x18,0xd1,0x7f,0x5e,0x73,0xcb,0x73,0x5b,0x74,0xdd,0xc1,0xc1,0xdc,
0xc0,0x4d,0x81,0x7c,0x93,0x65,0x72,0x87,0x30,0xd3,0x33,0x77,0x98,0xf1,0x14,0xb1,
0xb6,0x5f,0x84,0x71,0x84,0x07,0x42,0x9a,0x67,0xde,0xb6,0x90,0x5a,0xf5,0x46,0xc0,
0x9a,0xd4,0xf0,0xc7,0xa4,0xc4,0xdb,0x77,0x57,0xe2,0x71,0xec,0x4a,0x5f,0x16,0xe7,
0x32,0x33,0xcc,0x47,0x3d,0xdf,0x63,0x55,0x17,0x19,0x30,0x12,0xa6,0x2c,0x20,0xf8,
0x25,0x43,0xfb,0x49,0x10,0xb2,0xe5,0xe5,0x87,0x40,0x72,0x82,0xe7,0x20,0xd4,0xce,
};

const unsigned char cipher_sha256_chachapoly[] = { // results_3_2
0xce,0xf0,0x8a,0x52,0xef,0x83,0x8c,0xea,0x73,0xa6,0xfa,0xb0,0x19,0xe9,0x30,0x1d,
0x5b,0x4c,0x6a,0xc4,0x85,0x28,0xdb,0x77,0x9c,0x15,0x59,0x59,0x24,0x96,0x0d,0x05,
0x9c,0xa1,0xe9,0xaa,0x3f,0xaf,0x93,0xdd,0x45,0x21,0xb6,0x42,0xc3,0x31,0x3f,0x02,
0x77,0x1b,0xa3,0x7e,0x1a,0x4a,0x63,0xa3,0x59,0x4f,0x24,0x7e,0x3b,0xab,0xe3,0x83,
0xe0,0xce,0x35,0x32,0x50,0x90,0x4f,0x8e,0x5b,0x28,0x16,0x71,0xfa,0x75,0xde,0x9d,
0xbd,0xa5,0xa1,0x7f,0x21,0x90,0x7e,0x89,0x50,0xec,0x95,0x67,0x54,0x7f,0xdf,0xe1,
0x3f,0x6d,0x5f,0xac,0x6d,0x02,0xf9,0x45,0xa7,0x75,0xc4,0xbb,0x0d,0xf1,0x91,0x6c,
0x6d,0x39,0x24,0xdc,0x9d,0xe3,0x14,0x6b,0x7e,0x59,0x00,0xf3,0x63,0x32,0xeb,0xc6,
0x2a,0xcd,0x8e,0x1a,0x96,0xb2,0x86,0x47,0x1c,0x2d,0xe3,0xc5,0x6a,0x63,0xb3,0x4f,
0xee,0xef,0x9b,0xc2,0x25,0x36,0xaa,0xd3,0x59,0x1d,0x87,0x56,0xce,0x31,0xae,0x01,
0x2e,0x11,0x87,0xa0,0x58,0xca,0xa2,0x66,0x70,0x10,0x25,0x97,0x3f,0x0d,0x4f,0x26,
0x91,0x84,0xba,0x0d,0x09,0xf4,0x44,0xda,0x90,0x4d,0x3d,0x3f,0x8e,0xea,0x14,0x96,
0x27,0xbd,0x63,0x2f,0x62,0x7c,0x92,0x82,0x56,0x67,0xde,0x06,0x66,0x8d,0xbd,0xc0,
0x8c,0xa4,0xb3,0x2f,0x87,0xec,0xf7,0xf0,0xda,0x2a,0x5b,0x1e,0x2d,0xbd,0xc5,0xec,
0x72,0x3d,0x7b,0x32,0x93,0xab,0x0a,0x99,0x30,0x05,0x90,0x29,0xda,0x6c,0x37,0xf7,
0x0f,0x99,0x35,0x87,0x0b,0x0e,0x52,0x2b,0x9d,0x3e,0xb4,0x7b,0x7e,0xfd,0x15,0xeb,
0xff,0xb4,0x48,0x65,0xf6,0x61,0x18,0x32,0x31,0xc6,0x7b,0x54,0x55,0x16,0x17,0xcd,
};

const unsigned char cipher_sha384_chachapoly[] = { // results_4_2
0xac,0x94,0xcf,0x45,0xa5,0x61,0xa9,0xc9,0xe6,0x64,0xd1,0x70,0x21,0x1c,0x60,0xa1,
0xb0,0xd3,0x30,0x57,0x19,0x65,0xcf,0x90,0x0e,0x85,0x14,0xc4,0x61,0x6a,0xa4,0x40,
0xd5,0x95,0xbd,0xb9,0x3e,0x9c,0xb2,0xa3,0xa8,0x2b,0xf3,0x46,0xf3,0x40,0xb3,0xe5,
0x68,0x10,0x24,0xfa,0x5a,0x39,0x36,0x53,0x4c,0xd3,0xd9,0x8e,0xef,0xd9,0x18,0x8b,
0xf9,0xa3,0x84,0x7b,0xca,0x9f,0x6e,0x34,0x22,0xce,0x7c,0x7d,0x88,0x02,0x36,0xc1,
0xaa,0x71,0x6a,0xc6,0x4c,0x89,0x62,0xe2,0xcd,0xa4,0x05,0x57,0xe3,0xc3,0x74,0x09,
0xf2,0xfe,0x88,0xf0,0x03,0x89,0x83,0x62,0x48,0x6e,0x96,0x99,0xb4,0xd4,0x0d,0x3b,
0xc2,0x4c,0x5b,0x56,0xba,0x2a,0xf3,0xc7,0x92,0xe4,0x06,0x0c,0xc7,0xb6,0x9a,0xe3,
0xd3,0xde,0x32,0x87,0x78,0x3f,0x26,0xc8,0x6e,0x47,0xfa,0x4d,0x61,0x79,0x93,0xd7,
0x91,0x30,0x13,0x01,0x1a,0x72,0x31,0x62,0xb5,0x88,0x7c,0x30,0xff,0x7c,0x26,0xe3,
0x5a,0xef,0x75,0x1e,0x3f,0xec,0x24,0xf2,0x64,0x70,0xb5,0x21,0x35,0xb9,0xf3,0x72,
0x1f,0x8c,0x86,0xef,0xd8,0xad,0x5c,0x00,0xcc,0xdb,0x72,0x67,0x46,0xce,0x52,0x4f,
0xff,0x3a,0xc3,0xf5,0x6f,0xc5,0x31,0xc9,0xf0,0x2c,0xeb,0x4b,0xe5,0x57,0x6f,0x60,
0xc7,0x21,0x46,0xc8,0xca,0x71,0x56,0xab,0x3a,0x1b,0xf8,0x80,0x65,0xce,0xaf,0x65,
0xb7,0xe7,0x7c,0xfc,0x5b,0x20,0xdd,0xb5,0xcc,0xfa,0xcb,0xb5,0x89,0x34,0x9d,0x93,
0x1a,0xd2,0xe7,0x38,0x18,0xf4,0x19,0x9e,0xa9,0xa6,0xa5,0x74,0xee,0xe8,0xda,0xd8,
0x21,0xdc,0x1f,0xd7,0xd4,0x9e,0xf7,0x1d,0x22,0x2f,0xdc,0x79,0x36,0x04,0x20,0xc2,
};

const unsigned char cipher_sha512_chachapoly[] = { // results_5_2
0x25,0xd2,0x61,0xcf,0x30,0x66,0x1e,0xac,0x2a,0x80,0x23,0x7d,0xa0,0x2b,0xe1,0x4d,
0xb1,0x05,0x0e,0x3c,0x78,0xcf,0x13,0x7e,0x8a,0xd9,0xf2,0x3a,0x56,0x30,0xe3,0xbc,
0x4e,0x0e,0x4f,0x00,0x7b,0xf5,0x9e,0x3a,0xf6,0x47,0x11,0xcb,0x7d,0x38,0x73,0xb2,
0x44,0xd7,0x1b,0x93,0x53,0xfd,0x89,0x82,0x84,0xec,0x9f,0x1a,0xa8,0x32,0xcd,0x60,
0x32,0xd5,0xdc,0x13,0x52,0x02,0xee,0xee,0x98,0x1b,0xe0,0x87,0x3b,0xd5,0x23,0x0b,
0xa9,0xb2,0xbb,0x89,0x44,0x9a,0x1f,0xdf,0x8c,0x46,0x27,0x1d,0x24,0x4f,0x55,0x89,
0x3a,0xdc,0xad,0x26,0x9b,0xf6,0x04,0x6c,0x43,0x84,0x16,0xc2,0x2f,0xe8,0x6b,0xef,
0x1e,0x26,0xeb,0x62,0xe5,0x3c,0x99,0x38,0x8f,0xdd,0xb4,0xce,0x6d,0x93,0xd8,0xb5,
0xd5,0x0d,0xe3,0xc6,0x9e,0xd6,0x4b,0x11,0x86,0x1a,0xf6,0x4b,0x0e,0x35,0xdc,0x0a,
0x44,0x8a,0x6b,0xc8,0x57,0x80,0x66,0x85,0x8e,0xef,0xfb,0x79,0x90,0xc5,0x4a,0x2b,
0x6e,0xae,0x1a,0x37,0x67,0xc6,0x9b,0x51,0x3a,0x9f,0x6a,0xa1,0xfe,0xf7,0x9d,0x8f,
0x3c,0x2f,0x1c,0x46,0x8b,0x47,0xd2,0x73,0x09,0x9b,0xc1,0x14,0x71,0x16,0x95,0xab,
0x43,0x6e,0xd8,0x46,0x98,0x92,0x2d,0x84,0xd5,0xd9,0x6b,0x88,0x9a,0xad,0xa4,0x39,
0xc5,0x0d,0xc1,0xd9,0xa2,0xf9,0xe5,0x26,0xfc,0x7b,0x4e,0x60,0x20,0x8e,0x02,0xfc,
0x12,0xd6,0xf2,0x46,0xeb,0xb9,0x59,0x40,0x1d,0x24,0xdc,0x67,0x1f,0x38,0xe9,0xbf,
0x3a,0x88,0x83,0x1b,0x88,0xa5,0xc9,0x4f,0xbe,0x83,0xd6,0x70,0x03,0xab,0x47,0x7c,
0x3e,0xf6,0xb3,0x1d,0x9e,0xa9,0x0b,0x74,0x6d,0x8c,0x8d,0xbe,0xfe,0x6e,0x70,0xe6,
};

struct testcombination {
    mitls_hash hash;
    mitls_aead ae;
    const unsigned char *expected_cipher;
} testcombinations[] = {
    // TLS_hash_MD5 and TLS_hash_SHA1 aren't supported by libquiccrypto

    { TLS_hash_SHA256, TLS_aead_AES_128_GCM, cipher_sha256_aes128 },
    { TLS_hash_SHA384, TLS_aead_AES_128_GCM, cipher_sha384_aes128 },
    { TLS_hash_SHA512, TLS_aead_AES_128_GCM, cipher_sha512_aes128 },

    { TLS_hash_SHA256, TLS_aead_AES_256_GCM, cipher_sha256_aes256 },
    { TLS_hash_SHA384, TLS_aead_AES_256_GCM, cipher_sha384_aes256 },
    { TLS_hash_SHA512, TLS_aead_AES_256_GCM, cipher_sha512_aes256 },

    { TLS_hash_SHA256, TLS_aead_CHACHA20_POLY1305, cipher_sha256_chachapoly },
    { TLS_hash_SHA384, TLS_aead_CHACHA20_POLY1305, cipher_sha384_chachapoly },
    { TLS_hash_SHA512, TLS_aead_CHACHA20_POLY1305, cipher_sha512_chachapoly },

    { 0, 0, NULL }
};

// map mitls_hash to a string name
const char *hash_to_name[] = {
    "TLS_hash_MD5",
    "TLS_hash_SHA1",
    "TLS_hash_SHA224",
    "TLS_hash_SHA256",
    "TLS_hash_SHA384",
    "TLS_hash_SHA512"
};

// map mitls_aead to a string name
const char *aead_to_name[] = {
    "TLS_aead_AES_128_GCM",
    "TLS_aead_AES_256_GCM",
    "TLS_aead_CHACHA20_POLY1305"
};

void dumptofile(FILE *fp, const char buffer[], size_t len)
{
  size_t i;
  for(i=0; i<len; i++) {
    fprintf(fp, "0x%2.2x,", (unsigned char)buffer[i]);
    if (i % 16 == 15 || i == len-1) fprintf(fp, "\n");
  }
}

void check_result(const char* testname, const unsigned char *actual, const unsigned char *expected, uint32_t length)
{
    for (uint32_t i=0; i<length; ++i) {
        if (actual[i] != expected[i]) {
            printf("FAIL %s:  actual 0x%2.2x mismatch with expected 0x%2.2x at offset %u\n",
              testname, actual[i], expected[i], i);
            exit(1);
        }
    }
}

void test_crypto(const quic_secret *secret, const unsigned char *expected_cipher)
{
    int result;
    quic_key *key;
    unsigned char cipher[plain_len+16];

    printf("==== test_crypto(%s,%s) ====\n",
        hash_to_name[secret->hash], aead_to_name[secret->ae]);

    result = quic_crypto_derive_key(&key, secret);
    if (result == 0) {
        printf("FAIL: quic_crypto_derive_key failed\n");
        exit(1);
    }

    memset(cipher, 0, sizeof(cipher));
    result = quic_crypto_encrypt(key, cipher, sn, ad, ad_len, plain, plain_len);
    if (result == 0) {
        printf("FAIL: quic_crypto_encrypt failed\n");
        exit(1);
    }

#if 0
    // Capture expected results to files ready to paste into C source code
    char fname[64];
    sprintf(fname, "results_%d_%d", secret->hash, secret->ae);
    FILE *fp = fopen(fname, "w");
    dumptofile(fp, cipher, sizeof(cipher));
    fclose(fp);
#else
    // Verify that the computed text matches expectations
    check_result("quic_crypto_encrypt", cipher, expected_cipher, sizeof(cipher));
#endif

    unsigned char decrypted[plain_len];
    result = quic_crypto_decrypt(key, decrypted, sn, ad, ad_len, cipher, sizeof(cipher));
    if (result == 0) {
        printf("FAIL: quic_crypto_decrypt failed\n");
        exit(1);
    }
    check_result("quic_crypto_decrypt", decrypted, plain, sizeof(decrypted));

    result = quic_crypto_free_key(key);
    if (result == 0) {
        printf("FAIL: quic_crypto_free_key failed\n");
        exit(1);
    }

    printf("PASS\n");
}

const uint8_t expected_client_hs[] =  { // client_hs
0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x1a,0x96,0x01,0x16,0xaa,0x6c,0xe9,0x36,
0x88,0x3c,0xb1,0x79,0x97,0x74,0xcc,0x77,0xa4,0x91,0x6c,0xa5,0xbf,0x9c,0x9d,0x0b,
0x4b,0x97,0x96,0x82,0xf1,0x80,0x2b,0xa7,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
};

const uint8_t expected_server_hs[] = { // server_hs
0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x1b,0x91,0xb6,0x81,0xbb,0x78,0x4c,0xc9,
0x8c,0x5d,0x1f,0xf4,0x5f,0x90,0xfc,0x79,0x7f,0x4b,0x50,0x49,0xf7,0xf0,0x03,0xc7,
0xbb,0xf0,0x11,0xb3,0x23,0x0e,0xe3,0x5c,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
};

void test_handshake_secrets(void)
{
    int result;

    printf("==== test_handshake_secrets() ====\n");

    quic_secret client_hs;
    memset(&client_hs, 0, sizeof(client_hs));

    quic_secret server_hs;
    memset(&server_hs, 0, sizeof(server_hs));

    const unsigned char con_id[12] = {0xff,0xaa,0x55,0x00, 0x80,0x01,0x7f,0xee, 0x81,0x42,0x24,0x18 };
    const unsigned char salt[] = {0xaf,0xc8,0x24,0xec,0x5f,0xc7,0x7e,0xca,0x1e,0x9d,0x36,0xf3,0x7f,0xb2,0xd4,0x65,0x18,0xc3,0x66,0x39};
    result = quic_derive_handshake_secrets(&client_hs, &server_hs, con_id, sizeof(con_id), salt, sizeof(salt));
    if (result == 0) {
        printf("FAIL: quic_derive_handshake_secrets failed\n");
        exit(1);
    }

#if 0
    // Capture expected results to files ready to paste into C source code
    FILE *fp = fopen("client_hs", "w");
    dumptofile(fp, (const uint8_t*)&client_hs, sizeof(client_hs));
    fclose(fp);
    fp = fopen("server_hs", "w");
    dumptofile(fp, (const uint8_t*)&server_hs, sizeof(server_hs));
    fclose(fp);
#else
    // Verify that the computed text matches expectations
    check_result("quic_derive_handshake_secrets client", (const unsigned char*)&client_hs, (const unsigned char*)&expected_client_hs, sizeof(client_hs));
    check_result("quic_derive_handshake_secrets server", (const unsigned char*)&server_hs, (const unsigned char*)&expected_server_hs, sizeof(server_hs));
#endif

    printf("==== PASS: test_handshake_secrets ==== \n");
}

void exhaustive(void)
{
    quic_secret secret;

    for (unsigned char i=0; i<sizeof(secret.secret); ++i) {
        secret.secret[i] = i;
    }

    for (size_t i=0; testcombinations[i].expected_cipher; ++i) {
        secret.hash = testcombinations[i].hash;
        secret.ae = testcombinations[i].ae;

        test_crypto(&secret, testcombinations[i].expected_cipher);
    }

    test_handshake_secrets();
}

int CDECL main(int argc, char **argv)
{
    // Reference arguments to avoid compiler errors
    (void)argc;
    (void)argv;

    coverage();
    exhaustive();

    printf("==== ALL TESTS PASS ====\n");
}
